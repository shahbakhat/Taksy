
{% extends 'driver/base.html' %}

{% block head %}

<script
   src="https://maps.googleapis.com/maps/api/js?key=AIzaSyANA9ozNn4mr7ljTh97_4jgeeryhi5tsio&callback=initMap&libraries=places&v=weekly"
   defer
   ></script>

<script>
  function initMap() {
    // Initialize map for each job card
    const jobCards = document.querySelectorAll(".job-card");
    jobCards.forEach((card) => {
      const mapContainer = card.querySelector(".map-container");
      const pickupLat = parseFloat(card.dataset.pickupLat);
      const pickupLng = parseFloat(card.dataset.pickupLng);
      const dropoffLat = parseFloat(card.dataset.dropoffLat);
      const dropoffLng = parseFloat(card.dataset.dropoffLng);
  
      const map = new google.maps.Map(mapContainer, {
        center: { lat: pickupLat, lng: pickupLng },
        zoom: 13,
        disableDefaultUI: true, // Hide default map controls
        gestureHandling: "none", // Disable gesture handling (scroll, zoom)
        clickableIcons: false, // Disable clickable icons (POIs, businesses)
        keyboardShortcuts: false, // Disable keyboard shortcuts
        mapTypeControl: false, // Hide map type control
        streetViewControl: false, // Hide street view control
        fullscreenControl: false, // Hide fullscreen control
      });
  
      // Draw route from pickup to drop-off
      const directionsService = new google.maps.DirectionsService();
      const directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: true, // Do not display default markers
      });
      const request = {
        origin: { lat: pickupLat, lng: pickupLng },
        destination: { lat: dropoffLat, lng: dropoffLng },
        travelMode: google.maps.TravelMode.DRIVING,
      };
  
      directionsService.route(request, (result, status) => {
        if (status === google.maps.DirectionsStatus.OK) {
          directionsRenderer.setDirections(result);
        } else {
          console.error("Error retrieving directions:", status);
        }
      });
  
      // Add event listener to the "View Details" button
      const viewDetailsButton = card.querySelector(".btn");
      viewDetailsButton.addEventListener("click", () => {
        // Zoom in on the route
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(new google.maps.LatLng(pickupLat, pickupLng));
        bounds.extend(new google.maps.LatLng(dropoffLat, dropoffLng));
        map.fitBounds(bounds);
  
        // Clear the map
        directionsRenderer.setMap(null);
      });
    });
  }
  
</script>
{% endblock %}

{% block content %}
  {% if available_trips %}
  <span class="badge position-relative">
    My Jobs
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
      {{ available_trips|length }}
      <span class="visually-hidden">unread messages</span>
    </span>
  </span>
  <div class="row">
    {% for trip in available_trips %}
      <div class="card mb-4 col-4 center job-card" data-pickup-lat="{{ trip.pickup_lat }}" data-pickup-lng="{{ trip.pickup_lng }}" data-dropoff-lat="{{ trip.dropoff_lat }}" data-dropoff-lng="{{ trip.dropoff_lng }}">
        <h5 class="card-title text-center fw-bold">{{ trip.pickup_datetime }}</h5>
        <div class="card-body">
          <div class="map-container" style="height: 200px;"></div> <!-- Display the map inside the card -->
          <p class="card-text mt-4"><strong>From: </strong>{{ trip.pickup_address }}</p>
          <p class="card-text"><strong>To: </strong>{{ trip.dropoff_address }}</p>
          <p class="card-text fs-2"><strong>Distance: </strong>{{ trip.trip_distance }} Km</p>
          <p class="card-text"><strong>Description: </strong>{{ trip.description }}</p>
          <button type="button" class="btn float-end btn-lg btn-success">Accept</button>
        </div>
      </div>
    {% endfor %}
  </div>
  {% else %}
    <p>No available trips.</p>
  {% endif %}
{% endblock %}
